<!DOCTYPE html>
<html>

<head data-th-replace="~{header :: head}"></head>
<header data-th-replace="~{header :: #page-header}" />

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0zojwabqn9&submodules=geocoder"
    type="text/javascript"></script>
<script src="/js/mapUtils.js"></script>

<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-4">여행 동행모집 작성하기</h1>
            <button type="button" class="btn btn-secondary float-end" onclick="location.href='list'">목록</button>
        </div>

        <div class="mt-5">
            <!-- 여행일정 선택 및 선택 -->
            <form id="companionForm">
                <div name="Trip" id="Trip" class="mb-4">
                    <label for="tripSelect" class="form-label">여행 일정선택</label>
                    <select id="tripSelect" name="tripNo" class="form-select">
                        <option value="" disabled selected>여행 일정을 선택하세요</option>
                        <option data-th-each="trip : ${tripList}" data-th-value="${trip.tripNo}"
                            data-th-text="${trip.tripTitle}">
                        </option>
                    </select>
                </div>

                <!-- 동행모집 데이터 태그 랜더링 -->
                <div name="Companionrecruit" id="Companionrecruit">
                    <!-- 동행모집 데이터 랜더링 : 여행일정 정보 + 동행모집 체크(전체 체크 + 선택 체크) -->
                    <div id="scheduleListContainer" class="row" style="display: flex;"></div>
                </div><br><br>

                <!-- 지도 영역 -->
                <div class="container" style="max-width: 1200px; margin: 0 auto;">
                    <div id="map" style="width: 1200px; height: 400px;"></div>
                </div><br>

                <!-- 일반 게시판 데이터 -->
                <div name="Board" id="Board">
                    <div class="mb-3">
                        <label for="boardTitle" class="form-label">제목</label>
                        <input id="boardTitle" name="boardTitle" type="text" class="form-control"
                            placeholder="제목을 입력해 주세요." required maxlength="150">
                    </div>
                    <div class="mb-3">
                        <label for="boardTitle" class="form-label">내용</label>
                        <textarea id="boardContent" name="boardContent" type="text" class="form-control"
                            placeholder="내용을 입력해 주세요." required maxlength="300" style="resize: none;"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="boardTag" class="form-label">태그</label>
                        <input id="boardTag" name="boardTag" type="text" class="form-control"
                            placeholder="#태그를 입력해 주세요." required maxlength="15">
                    </div>
                    <!-- 파일 첨부 -->
                    <div class="mb-3">
                        <label for="file-upload" class="form-label">파일 첨부</label>
                        <input id="file-upload" name="imageFiles" type="file" class="form-control" multiple
                            onchange="previewImages()">
                    </div>

                    <button type="submit" class="btn btn-primary">등록</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        function previewImages() {
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = ''; // 기존 미리보기 초기화

            const files = document.getElementById('file-upload').files;
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewItem = document.createElement('div');
                    previewItem.classList.add('d-inline-block', 'position-relative', 'm-2');

                    previewItem.innerHTML = `
                        <img src="${e.target.result}" class="img-thumbnail" style="width: 100px; height: 100px;"> <p class="text-center mt-1">${file.name}</p>
                        <button type="button" class="btn-close position-absolute top-0 start-80" onclick="removeImage(${index})"></button>`;
                    previewContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeImage(index) {
            const fileInput = document.getElementById('file-upload');
            const dt = new DataTransfer();

            Array.from(fileInput.files).forEach((file, i) => {
                if (i !== index) dt.items.add(file); // 선택한 인덱스 제외
            });

            fileInput.files = dt.files;
            previewImages(); // 미리보기 다시 로드
        }
    </script>


    <script>
        // 동적 태그생성 감지 함수 선언
        const observer = new MutationObserver((mutationsList) => {
            var columnItems = '';
            var locationXSpan = '';

            var locationX = '';
            var locationY = '';

            var markers = new Array;

            var locationXList = [];
            var locationYList = [];
            var locationList = [];

            // 초기 네이버 지도 랜더링
            var map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.3595704, 127.105399),
                zoom: 10
            });

            mutationsList.forEach((mutation) => {
                if (mutation.type === "childList") {
                    mutation.addedNodes.forEach((node) => {
                        // 요소 노드만 처리
                        if (node.nodeType === 1) {
                            // 동적태그 생성감지 확인용 console.log
                            console.log("새로운 태그가 추가되었습니다:", node);

                            // 동적태그 : 좌표 태그의 태그값 추출
                            const scheduleListContainer = document.getElementById('scheduleListContainer');
                            if (scheduleListContainer) {
                                columnItems = scheduleListContainer.getElementsByClassName('column-item text-dark p-1');

                                // column-item 태그를 하나씩 조회
                                for (let i = 0; i < columnItems.length; i++) {
                                    const columnItem = columnItems[i];

                                    // column-item 태그 안의 location-x-d-none 및 location-y-d-none 조회
                                    locationXSpan = columnItem.querySelector('span.location-x.d-none');
                                    locationYSpan = columnItem.querySelector('span.location-y.d-none');

                                    if (locationXSpan && locationYSpan) {
                                        // 추출한 값들을 변수에 저장
                                        locationX = parseFloat(locationXSpan.textContent);
                                        locationY = parseFloat(locationYSpan.textContent);

                                        locationXList.push(locationX);
                                        locationYList.push(locationY);

                                        locationList.push({ lat: locationX, lng: locationY });

                                        var marker = new naver.maps.Marker({
                                            position: new naver.maps.LatLng(locationX, locationY),
                                            map: map
                                        });
                                        markers.push(marker);
                                    }
                                }

                                // 저장된 값들을 출력
                                console.log('locationX values:', locationXList);
                                console.log('locationY values:', locationYList);
                                console.log('locationList values : ', locationList);
                            }
                        }
                    });
                }
            });
        });
        // 동적 태그생성 감지 설정( 감지범위 : 자식태그 포함 )
        const container = document.getElementById("scheduleListContainer");
        observer.observe(container, { childList: true });
    </script>

    <script>
        // scheduleListContainer 태그 - 자식 태그 동적 생성
        document.getElementById('tripSelect').addEventListener('change', function () {
            const tripNo = this.value;
            const formData = new URLSearchParams();
            formData.append('tripNo', tripNo);

            fetch('/companion/selectSchedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            })
                .then(response => response.json())
                .then(data => {
                    const scheduleList = data;

                    // Step 6: Grouping schedules by day
                    let scheduleGroups = {};
                    scheduleList.forEach(schedule => {
                        if (!scheduleGroups[schedule.scheduleDay]) {
                            scheduleGroups[schedule.scheduleDay] = [];
                        }
                        scheduleGroups[schedule.scheduleDay].push(schedule);
                    });

                    // Step 1: Finding the columns-container div and clearing previous content once
                    const columnsContainer = document.getElementById('scheduleListContainer');
                    columnsContainer.innerHTML = ''; // Clear previous content once before the loop

                    let currentRow;
                    let itemCount = 0;

                    for (const [day, schedules] of Object.entries(scheduleGroups)) {
                        // Step 3: Creating the column-item div
                        if (itemCount % 3 === 0) {
                            currentRow = document.createElement('div');
                            currentRow.className = 'row w-100 mb-4';
                            columnsContainer.appendChild(currentRow);
                        }

                        const columnItem = document.createElement('div');
                        columnItem.className = 'column-item text-dark p-1 col-md-4';
                        columnItem.style.width = '300px';
                        columnItem.style.minWidth = '400px';

                        // Step 4: Creating the fw-bold div
                        const fwBoldDiv = document.createElement('div');
                        fwBoldDiv.className = 'fw-bold mb-2 d-flex align-items-center';

                        // Step 5: Setting text content for the fw-bold div
                        fwBoldDiv.textContent = 'Day ' + day + '   ';

                        // Adding a button to the fw-bold div
                        const addCheckBox = document.createElement('input');
                        addCheckBox.type = 'checkbox';
                        addCheckBox.className = 'form-check-input me-2';
                        const fullScheduleText = document.createElement('span');
                        fullScheduleText.textContent = '   전일정 동행 구함';
                        fullScheduleText.style.marginLeft = 'auto';
                        fwBoldDiv.appendChild(fullScheduleText);
                        fwBoldDiv.appendChild(addCheckBox);

                        // Adding fw-bold div to column-item div
                        columnItem.appendChild(fwBoldDiv);

                        // Adding event listener to the checkbox to display input for maximum people and disable buttons
                        addCheckBox.addEventListener('change', function () {
                            const existingMaxPeopleContainerAll = fwBoldDiv.nextElementSibling;
                            const locationCards = columnItem.querySelectorAll('#locationCard');
                            if (this.checked) {
                                if (!existingMaxPeopleContainerAll || existingMaxPeopleContainerAll.id !== 'maxPeopleContainerAll') {
                                    const maxPeopleContainerAll = document.createElement('div');
                                    maxPeopleContainerAll.className = 'd-flex align-items-center mt-2';
                                    maxPeopleContainerAll.id = 'maxPeopleContainerAll';

                                    const maxPeopleLabel = document.createElement('label');
                                    maxPeopleLabel.className = 'form-label me-2';
                                    maxPeopleLabel.textContent = '최대 모집 인원';

                                    const maxPeopleInputAll = document.createElement('input');
                                    maxPeopleInputAll.className = 'form-control';
                                    maxPeopleInputAll.type = 'number';
                                    maxPeopleInputAll.style.width = '55px';
                                    maxPeopleInputAll.min = 1;
                                    maxPeopleInputAll.max = 10;
                                    maxPeopleInputAll.value = 1;

                                    // Adding event listener to validate input value
                                    maxPeopleInputAll.addEventListener('input', function () {
                                        if (this.value < 1) {
                                            alert('잘못된 입력값 입니다');
                                            this.value = 1;
                                        }
                                    });

                                    maxPeopleContainerAll.appendChild(maxPeopleLabel);
                                    maxPeopleContainerAll.appendChild(maxPeopleInputAll);
                                    fwBoldDiv.insertAdjacentElement('afterend', maxPeopleContainerAll);
                                }

                                // 체크박스가 체크될 때 해당 column-item 안의 모든 locationCard 태그 조회 및 처리
                                locationCards.forEach(locationCard => {
                                    console.log('locationCard:', locationCard);

                                    const alignItemsDiv = locationCard.querySelector('.d-flex.align-items-start.gap-1.mt-1');
                                    const addBtn = alignItemsDiv ? alignItemsDiv.querySelector('#addBtn') : null;

                                    if (addBtn) {
                                        console.log('addBtn found:', addBtn);
                                        addBtn.disabled = true;

                                        const addIcon = addBtn.querySelector('i');

                                        addIcon.classList.remove('bi-plus-lg');
                                        addIcon.classList.add('bi-check-lg');
                                    } else {
                                        console.log("조회할 button 태그가 없습니다");
                                    }
                                });

                            } else {
                                if (existingMaxPeopleContainerAll && existingMaxPeopleContainerAll.id === 'maxPeopleContainerAll') {
                                    existingMaxPeopleContainerAll.remove();
                                }
                                // 체크박스가 체크 해제 될 때 해당 column-item 안의 모든 locationCard 태그 조회 및 처리
                                locationCards.forEach(locationCard => {
                                    console.log('locationCard:', locationCard);

                                    const alignItemsDiv = locationCard.querySelector('.d-flex.align-items-start.gap-1.mt-1');
                                    const addBtn = alignItemsDiv ? alignItemsDiv.querySelector('#addBtn') : null;

                                    if (addBtn) {
                                        console.log('addBtn found:', addBtn);
                                        addBtn.disabled = false;

                                        const addIcon = addBtn.querySelector('i');

                                        addIcon.classList.remove('bi-check-lg');
                                        addIcon.classList.add('bi-plus-lg');
                                    } else {
                                        console.log("조회할 button 태그가 없습니다");
                                    }
                                });
                            }


                        });

                        const addedScheduleRoutes = new Set();

                        schedules.forEach(schedule => {
                            if (!addedScheduleRoutes.has(schedule.scheduleRoute)) {
                                addedScheduleRoutes.add(schedule.scheduleRoute);

                                const cardDiv = document.createElement('div');
                                cardDiv.className = 'card border-0';
                                cardDiv.id = 'locationCard';
                                cardDiv.style.width = '100%';
                                cardDiv.style.height = '100px';
                                cardDiv.style.position = 'relative';

                                const alignItemsDiv = document.createElement('div');
                                alignItemsDiv.className = 'd-flex align-items-start gap-1 mt-1';
                                alignItemsDiv.style.height = '200%';

                                const positionRelativeDiv = document.createElement('div');
                                positionRelativeDiv.className = 'position-relative d-flex flex-column align-items-center';
                                positionRelativeDiv.style.height = '100%';

                                const m2Div = document.createElement('div');
                                m2Div.className = 'm-2 d-flex justify-content-center align-items-center rounded-circle text-white bg-primary';
                                m2Div.style.width = '20px';
                                m2Div.style.height = '20px';
                                m2Div.style.fontSize = '10px';
                                m2Div.textContent = schedule.scheduleRoute;

                                const positionAbsoluteDiv = document.createElement('div');
                                positionAbsoluteDiv.className = 'position-absolute bg-primary';
                                positionAbsoluteDiv.style.width = '2px';
                                positionAbsoluteDiv.style.height = 'calc(100% - 20px)';
                                positionAbsoluteDiv.style.top = '30px';
                                positionAbsoluteDiv.style.left = '50%';
                                positionAbsoluteDiv.style.transform = 'translateX(-50%)';

                                const flexColumnDiv = document.createElement('div');
                                flexColumnDiv.className = 'd-flex flex-column align-items-start mt-2';

                                const locationTypeP = document.createElement('p');
                                locationTypeP.className = 'mb-0 bg-info rounded text-white p-1';
                                locationTypeP.style.fontSize = '12px';
                                locationTypeP.textContent = schedule.scheduleRoute == 0 ? '숙박업소' : '관광명소';

                                const locationNameP = document.createElement('p');
                                locationNameP.className = 'fs-6 fw-bold mb-0';
                                locationNameP.textContent = schedule.location.locationName;

                                flexColumnDiv.appendChild(locationTypeP);
                                flexColumnDiv.appendChild(locationNameP);

                                const containerDiv = document.createElement('div');
                                containerDiv.className = 'd-flex align-items-center';

                                const locationImage = document.createElement('img');
                                locationImage.alt = 'Location Image';
                                locationImage.className = 'rounded me-3 h-100 ms-auto';
                                locationImage.style.width = '60px';
                                locationImage.style.objectFit = 'cover';
                                locationImage.src = schedule.location.locationPhoto;
                                containerDiv.appendChild(locationImage);

                                if (schedule.scheduleRoute != 0) {
                                    const addBtn = document.createElement('button');
                                    addBtn.id = 'addBtn';
                                    addBtn.className = 'btn btn-outline-secondary btn-location d-flex justify-content-center align-items-center';
                                    addBtn.type = 'button';
                                    addBtn.setAttribute('data-th-attr', 'data-index=${status.index}');
                                    addBtn.style.height = '60px';
                                    addBtn.style.width = '30px';
                                    addBtn.dataset.value = '0';
                                    const addIcon = document.createElement('i');
                                    addIcon.className = 'bi bi-plus-lg';
                                    addBtn.appendChild(addIcon);
                                    containerDiv.appendChild(addBtn);

                                    addBtn.addEventListener('click', function () {
                                        const existingMaxPeopleContainerSelectDiv = alignItemsDiv.querySelector('#maxPeopleContainerSelectDiv');

                                        if (addIcon) {
                                            if (addBtn.dataset.value === '0') {
                                                addBtn.dataset.value = '1';
                                                addIcon.classList.remove('bi-plus-lg');
                                                addIcon.classList.add('bi-check-lg');
                                                addCheckBox.disabled = true; // 전일정 동행 구함 체크박스 비활성화

                                                // 모집 인원 input 태그 추가 생성
                                                if (!existingMaxPeopleContainerSelectDiv) {
                                                    const maxPeopleContainer = document.createElement('div');
                                                    maxPeopleContainer.className = 'd-flex flex-column';
                                                    maxPeopleContainer.id = 'maxPeopleContainerSelectDiv';
                                                    maxPeopleContainer.style.display = 'block';

                                                    const maxPeopleLabel = document.createElement('label');
                                                    maxPeopleLabel.className = 'form-label me-2';
                                                    maxPeopleLabel.id = 'maxPeopleInputSelectLabel';
                                                    maxPeopleLabel.style.width = '200%';
                                                    maxPeopleLabel.textContent = '모집인원';

                                                    const maxPeopleInput = document.createElement('input');
                                                    maxPeopleInput.className = 'form-control';
                                                    maxPeopleInput.id = 'maxPeopleSelectInput';
                                                    maxPeopleInput.type = 'number';
                                                    maxPeopleInput.style.width = '55px';
                                                    maxPeopleInput.style.display = 'block';
                                                    maxPeopleInput.min = 1;
                                                    maxPeopleInput.max = 10;
                                                    maxPeopleInput.value = 1;

                                                    maxPeopleContainer.appendChild(maxPeopleLabel);
                                                    maxPeopleContainer.appendChild(maxPeopleInput);
                                                    alignItemsDiv.appendChild(maxPeopleContainer);
                                                }
                                            } else {
                                                addBtn.dataset.value = '0';
                                                addIcon.classList.remove('bi-check-lg');
                                                addIcon.classList.add('bi-plus-lg');
                                                addBtn.disabled = false;
                                                addCheckBox.disabled = false; // 전일정 동행 구함 체크박스 활성화

                                                // 모집인원 제거
                                                if (existingMaxPeopleContainerSelectDiv) {
                                                    existingMaxPeopleContainerSelectDiv.remove();
                                                }
                                            }
                                        }
                                    });
                                }

                                positionRelativeDiv.appendChild(m2Div);
                                positionRelativeDiv.appendChild(positionAbsoluteDiv);

                                const daySpan = document.createElement('span');
                                daySpan.className = 'day d-none';
                                daySpan.textContent = schedule.scheduleDay;

                                const routeSpan = document.createElement('span');
                                routeSpan.className = 'route d-none';
                                routeSpan.textContent = schedule.scheduleRoute;

                                const scheduleNoSpan = document.createElement('span');
                                scheduleNoSpan.className = 'schedule-no d-none';
                                scheduleNoSpan.textContent = schedule.scheduleNo;

                                const locationXSpan = document.createElement('span');
                                locationXSpan.className = 'location-x d-none';
                                locationXSpan.textContent = schedule.location.locationX;

                                const locationYSpan = document.createElement('span');
                                locationYSpan.className = 'location-y d-none';
                                locationYSpan.textContent = schedule.location.locationY;

                                alignItemsDiv.appendChild(positionRelativeDiv);
                                alignItemsDiv.appendChild(flexColumnDiv);
                                alignItemsDiv.appendChild(containerDiv);
                                alignItemsDiv.appendChild(daySpan);
                                alignItemsDiv.appendChild(routeSpan);
                                alignItemsDiv.appendChild(scheduleNoSpan);
                                alignItemsDiv.appendChild(locationXSpan);
                                alignItemsDiv.appendChild(locationYSpan);

                                cardDiv.appendChild(alignItemsDiv);
                                columnItem.appendChild(cardDiv);
                            }
                        });

                        currentRow.appendChild(columnItem);
                        itemCount++;
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    </script>

    <!-- 데이터 전송 스크립트 코드 -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('companionForm').addEventListener('submit', function (event) {
                event.preventDefault();

                // 2. 여행 일정 선택 데이터 수집
                const tripNo = document.getElementById('tripSelect').value;

                // 3. 일반 게시판 데이터 수집
                const boardTitle = document.getElementById('boardTitle').value;
                const boardContent = document.getElementById('boardContent').value;
                const boardTag = document.getElementById('boardTag').value;

                // 4. board 객체 생성
                const board = {
                    tripNo: tripNo,
                    boardTitle: boardTitle,
                    boardContent: boardContent,
                    boardTag: boardTag
                };

                // 5. companionRecruits List 형태의 변수 생성
                const companionRecruits = [];

                // 6. 동행모집 데이터 수집
                const scheduleListContainer = document.getElementById('scheduleListContainer');
                const columnItems = scheduleListContainer.querySelectorAll('.column-item.text-dark.p-1');

                columnItems.forEach(columnItem => {
                    const checkBox = columnItem.querySelector('.fw-bold input[type="checkbox"]');
                    const scheduleNo = columnItem.querySelector('.schedule-no').textContent;

                    if (checkBox && checkBox.checked) {
                        // 5-2-1-1) 체크박스가 체크되어 있을 경우
                        const recruitMaxNo = columnItem.querySelector('#maxPeopleContainerAll input').value;

                        companionRecruits.push({
                            scheduleNo: scheduleNo,
                            checked: false,
                            checkedAll: true,
                            recruitMaxNo: recruitMaxNo
                        });
                    } else {
                        // 5-2-2-1) 체크박스가 체크되어 있지 않을 경우
                        const locationCards = columnItem.querySelectorAll('#locationCard');

                        locationCards.forEach(locationCard => {
                            const addBtn = locationCard.querySelector('#addBtn');
                            const addIcon = addBtn ? addBtn.querySelector('i') : null;

                            if (addIcon && addIcon.classList.contains('bi-check-lg')) {
                                // 버튼이 클릭된 상태일 경우
                                const recruitMaxNoInput = columnItem.querySelector('#maxPeopleInputSelect');
                                let recruitMaxNo = recruitMaxNoInput.value;
                                if (recruitMaxNo <= 0) {
                                    alert('잘못된 값이 있습니다 재 입력 해주세요');
                                    recruitMaxNoInput.focus();
                                    return;
                                }

                                companionRecruits.push({
                                    scheduleNo: scheduleNo,
                                    checked: true,
                                    checkedAll: false,
                                    recruitMaxNo: recruitMaxNo
                                });
                            }
                        });
                    }
                });

                // 7. addrequest 객체 생성
                const addrequest = {
                    board: board,
                    companionRecruits: companionRecruits
                };

                // 8. add 메서드로 POST 요청 보내기
                fetch('add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(addrequest)
                })
                    .then(response => {
                        if (response.ok) {
                            alert('정상적으로 글 등록 되었습니다');
                            location.href = 'list';
                        } else {
                            alert('글 등록에 실패했습니다.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('글 등록 중 에러가 발생 했습니다');
                    });
            });
        });
    </script>
</body>

</html>