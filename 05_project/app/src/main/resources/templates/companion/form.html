<!DOCTYPE html>
<html>

<head data-th-replace="~{header :: head}"></head>
<header data-th-replace="~{header :: #page-header}"/>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<body>
<!--Naver MAP API-->
<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0zojwabqn9&submodules=geocoder"></script>

<div class="container mt-5">
    <h1 class="mb-4">여행 동행 작성하기</h1>

    <div class="mt-5">
        <!-- 여행일정 선택 및 선택 -->
        <form>
            <div name="Trip" id="Trip" class="mb-4">
                <label for="tripSelect" class="form-label">여행 일정선택</label>
                <select id="tripSelect" name="tripNo" class="form-select">
                    <option value="" disabled selected>여행 일정을 선택하세요</option>
                    <option data-th-each="trip : ${tripList}" data-th-value="${trip.tripNo}"
                            data-th-text="${trip.tripTitle}">
                    </option>
                </select>
            </div>

            <!-- 동행모집 데이터 태그 랜더링 -->
            <div name="Companionrecruit" id="Companionrecruit">
                <!-- 동행모집 데이터 랜더링 : 여행일정 정보 + 동행모집 체크(전체 체크 + 선택 체크) -->
                <div id="scheduleListContainer" style="display: flex;"></div>
            </div><br><br>

            <!-- 지도 영역 -->
            <div class="container" style="max-width: 1200px; margin: 0 auto;">
                <div id="map" style="width: 1200px; height: 400px;"></div>
            </div><br>

            <!-- 일반 게시판 데이터 -->
            <div name="Board" id="Board">
                <div class="mb-3">
                    <label for="boardTitle" class="form-label">제목</label>
                    <input id="boardTitle" name="boardTitle" type="text" class="form-control" placeholder="제목을 입력해 주세요." required maxlength="150">
                </div>
                <div class="mb-3">
                    <label for="boardTitle" class="form-label">내용</label>
                    <textarea id="boardContent" name="boardContent" type="text" class="form-control" placeholder="내용을 입력해 주세요." required maxlength="300"></textarea><br><br>
                </div>
                <div class="mb-3">
                    <label for="boardTag" class="form-label" >태그</label>
                    <input id="boardTag" name="boardTag" type="text" class="form-control" placeholder="#태그를 입력해 주세요." required maxlength="15">
                </div>
                <!-- 파일 첨부 -->
                <div class="mb-3">
                    <label for="file-upload" class="form-label">파일 첨부</label>
                    <input id="file-upload" name="imageFiles" type="file" class="form-control" multiple onchange="previewImages()">
                </div>
                <button type="button" onclick="location.href='list'">목록</button>
                <button type="button" onclick="submitBoardForm()">글등록</button>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript -->
<script>
    var mapOptions = {
        center: new naver.maps.LatLng(37.3595704, 127.105399), // 지도의 초기 위치 설정
        zoom: 10 // 초기 확대 수준
    };

    // 네이버 지도를 #map 요소에 렌더링
    var map = new naver.maps.Map('map', mapOptions);

    // 사용자가 선택한 여행 일정의 위치로 지도를 이동시키는 함수
    document.getElementById('tripSelect').addEventListener('change', function () {
        const tripNo = this.value;
        const formData = new URLSearchParams();
        formData.append('tripNo', tripNo);

        fetch('/companion/selectSchedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData.toString()
        })
        .then(response => response.json())
        .then(data => {
            const scheduleList = data;

            // Step 6: Grouping schedules by day
            let scheduleGroups = {};
            scheduleList.forEach(schedule => {
                if (!scheduleGroups[schedule.scheduleDay]) {
                    scheduleGroups[schedule.scheduleDay] = [];
                }
                scheduleGroups[schedule.scheduleDay].push(schedule);
            });

            // Step 1: Finding the columns-container div and clearing previous content once
            const columnsContainer = document.getElementById('scheduleListContainer');
            columnsContainer.innerHTML = ''; // Clear previous content once before the loop

            for (const [day, schedules] of Object.entries(scheduleGroups)) {
                // Step 3: Creating the column-item div
                const columnItem = document.createElement('div');
                columnItem.className = 'column-item text-dark p-1';
                columnItem.style.width = '300px';
                columnItem.style.minWidth = '300px';

                // Step 4: Creating the fw-bold div
                const fwBoldDiv = document.createElement('div');
                fwBoldDiv.className = 'fw-bold mb-2';

                // Step 5: Setting text content for the fw-bold div
                fwBoldDiv.textContent = 'Day ' + day;

                // Adding fw-bold div to column-item div
                columnItem.appendChild(fwBoldDiv);

                const addedScheduleRoutes = new Set();

                schedules.forEach(schedule => {
                    if (!addedScheduleRoutes.has(schedule.scheduleRoute)) {
                        addedScheduleRoutes.add(schedule.scheduleRoute);

                        const cardDiv = document.createElement('div');
                        cardDiv.className = 'card border-0';
                        cardDiv.id = 'locationCard';
                        cardDiv.style.width = '100%';
                        cardDiv.style.height = '100px';
                        cardDiv.style.position = 'relative';

                        const alignItemsDiv = document.createElement('div');
                        alignItemsDiv.className = 'd-flex align-items-start gap-1 mt-1';
                        alignItemsDiv.style.height = '100%';

                        const positionRelativeDiv = document.createElement('div');
                        positionRelativeDiv.className = 'position-relative d-flex flex-column align-items-center';
                        positionRelativeDiv.style.height = '100%';

                        const m2Div = document.createElement('div');
                        m2Div.className = 'm-2 d-flex justify-content-center align-items-center rounded-circle text-white';
                        m2Div.style.width = '20px';
                        m2Div.style.height = '20px';
                        m2Div.style.fontSize = '10px';
                        m2Div.textContent = schedule.scheduleRoute;

                        const positionAbsoluteDiv = document.createElement('div');
                        positionAbsoluteDiv.className = 'position-absolute';
                        positionAbsoluteDiv.style.width = '2px';
                        positionAbsoluteDiv.style.height = 'calc(100% - 20px)';
                        positionAbsoluteDiv.style.top = '30px';
                        positionAbsoluteDiv.style.left = '50%';
                        positionAbsoluteDiv.style.transform = 'translateX(-50%)';

                        const flexColumnDiv = document.createElement('div');
                        flexColumnDiv.className = 'd-flex flex-column align-items-start mt-2';

                        const locationTypeP = document.createElement('p');
                        locationTypeP.className = 'mb-0 bg-info rounded text-white p-1';
                        locationTypeP.style.fontSize = '12px';
                        locationTypeP.textContent = schedule.scheduleRoute == 0 ? '숙박업소' : '관광명소';

                        const locationNameP = document.createElement('p');
                        locationNameP.className = 'fs-6 fw-bold mb-0';
                        locationNameP.textContent = schedule.location.locationName;

                        const locationImage = document.createElement('img');
                        locationImage.alt = 'Location Image';
                        locationImage.className = 'rounded me-3 h-100 ms-auto';
                        locationImage.style.width = '60px';
                        locationImage.style.objectFit = 'cover';
                        locationImage.src = schedule.location.locationPhoto;

                        const daySpan = document.createElement('span');
                        daySpan.className = 'day d-none';
                        daySpan.textContent = schedule.scheduleDay;

                        const routeSpan = document.createElement('span');
                        routeSpan.className = 'route d-none';
                        routeSpan.textContent = schedule.scheduleRoute;

                        const scheduleNoSpan = document.createElement('span');
                        scheduleNoSpan.className = 'schedule-no d-none';
                        scheduleNoSpan.textContent = schedule.scheduleNo;

                        const locationXSpan = document.createElement('span');
                        locationXSpan.className = 'location-x d-none';
                        locationXSpan.textContent = schedule.location.locationX;

                        const locationYSpan = document.createElement('span');
                        locationYSpan.className = 'location-y d-none';
                        locationYSpan.textContent = schedule.location.locationY;

                        positionRelativeDiv.appendChild(m2Div);
                        positionRelativeDiv.appendChild(positionAbsoluteDiv);

                        flexColumnDiv.appendChild(locationTypeP);
                        flexColumnDiv.appendChild(locationNameP);

                        alignItemsDiv.appendChild(positionRelativeDiv);
                        alignItemsDiv.appendChild(flexColumnDiv);
                        alignItemsDiv.appendChild(locationImage);
                        alignItemsDiv.appendChild(daySpan);
                        alignItemsDiv.appendChild(routeSpan);
                        alignItemsDiv.appendChild(scheduleNoSpan);
                        alignItemsDiv.appendChild(locationXSpan);
                        alignItemsDiv.appendChild(locationYSpan);

                        cardDiv.appendChild(alignItemsDiv);
                        columnItem.appendChild(cardDiv);
                    }
                });

                columnsContainer.appendChild(columnItem);
            }
        })
        .catch(error => console.error('Error:', error));
    });
</script>


</body>

</html>
