

<h3>ëŒ“ê¸€ ì‘ì„±</h3>
<form data-th-action="@{/comment/add}" method="post">
    <textarea name="commentContent" rows="4" cols="100" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <input type="hidden" name="boardType" value="1">
    <input type="hidden" name="boardNo" data-th-value="${board.boardNo}"> <br>
    <button type="submit">ëŒ“ê¸€ ë“±ë¡</button>
</form>

<br> ëŒ“ê¸€ ëª©ë¡ <br>

<select id="commentSort" onchange="changeCommentSort()">
    <option value="registered" data-th-selected="${sort == 'registered'}">ë“±ë¡ìˆœ</option>
    <option value="likes" data-th-selected="${sort == 'likes'}">ì¢‹ì•„ìš”ìˆœ</option>
</select>

<p data-th-unless="${commentList}">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>

<ul data-th-if="${commentList != null and commentList.size() > 0}">
    <li data-th-each="comment : ${commentList}">

        ìœ ì € í¬í† : <img data-th-src="@{/images/default.png}"
                    data-th-unless="${board.writer.userPhoto}"
                    src="/images/default.png"
                    style="width: 40px; height: 35px;"> <br>
        ìœ ì € ë‹‰ë„¤ì„: <td data-th-text="${board.writer.userNickname}">ë‹‰ë„¤ì„</td><br>
        ë‚´ìš©: <br>
        <textarea name="commentContent" readonly rows="5" cols="50" data-th-text="${comment.commentContent}"></textarea><br>
        ì‘ì„±ì¼: <input readonly data-th-value="${#calendars.format(comment.commentCreatedDate,'yyyyë…„ MMì›” ddì¼ HH:mm') }" size="20"> <br>

        <!--        <div>-->
        <!--            <button type="button" data-th-onclick="|toggleCommentLike(${comment.commentNo})|"-->
        <!--                    data-th-text="${comment.isCommentLiked ? 'ì¢‹ì•„ìš” ì·¨ì†Œ' : 'ì¢‹ì•„ìš”'}">-->
        <!--            </button>-->
        <!--            <span data-th-text="${comment.commentLikeCount}">0</span>-->
        <!--        </div>-->

        <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
        <div>
            <button type="button"
                    data-th-id="'commentLikeButton-' + ${comment.commentNo}"
                    data-th-onclick="|toggleCommentLike(${comment.commentNo})|"
                    data-th-text="${commentLikedMap[comment.commentNo] != null && commentLikedMap[comment.commentNo] ? 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ' : 'ğŸ¤ ì¢‹ì•„ìš”'}">
            </button>
            <input type="text"
                   readonly
                   data-th-id="'commentLikeCount-' + ${comment.commentNo}"
                   data-th-value="${comment.commentLike}">
        </div>

        <div data-th-if="${isLoggedIn and comment.userNo == loginUserNo}">
            <button type="button" onclick="enableEdit(this)">ìˆ˜ì •</button>
            <button type="button" data-th-onclick="|updateComment(${comment.commentNo}, ${board.boardNo}, this)|"
                    style="display: none;">ì €ì¥
            </button>
            <button type="button" onclick="cancelEdit(this)" style="display: none;">ì·¨ì†Œ</button>
            <button type="button" data-th-onclick="|deleteComment(${comment.commentNo}, ${board.boardNo})|">ì‚­ì œ</button>
        </div>
    </li>
</ul>

<div>

    <span data-th-if="${currentPage > 1}">
        <a data-th-href="@{|?boardNo=${board.boardNo}&page=${currentPage - 1}|}">
            [ì´ì „]
        </a>
    </span>
    <span data-th-unless="${currentPage > 1}">[ì´ì „]</span>


    <span data-th-each="i : ${#numbers.sequence(1, totalPages)}">
        <a data-th-href="@{|?boardNo=${board.boardNo}&page=${i}|}"
           data-th-classappend="${i == currentPage} ? 'active' : ''"
           data-th-text="${i}">

           1
        </a>
    </span>


    <span data-th-if="${currentPage < totalPages}">
        <a data-th-href="@{|?boardNo=${board.boardNo}&page=${currentPage + 1}|}">
            [ë‹¤ìŒ]
        </a>
    </span>
    <span data-th-unless="${currentPage < totalPages}">[ë‹¤ìŒ]</span>
</div>

<script>
    function enableEdit(button) {

        const listItem = button.closest('li');
        const textarea = listItem.querySelector('textarea');

        // í˜„ì¬ ë‚´ìš©ì„ ì €ì¥í•´ë‘ 
        textarea.setAttribute('data-original-content', textarea.value);

        // í…ìŠ¤íŠ¸ ì˜ì—­ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
        textarea.removeAttribute('readonly');
        button.style.display = 'none'; // ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        // ì €ì¥ ë° ì·¨ì†Œ ë²„íŠ¼ì„ ì°¾ê³  í‘œì‹œ
        listItem.querySelector('button[onclick^="updateComment"]').style.display = 'inline'; // ì €ì¥ ë²„íŠ¼ í‘œì‹œ
        listItem.querySelector('button[onclick^="cancelEdit"]').style.display = 'inline'; // ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
        listItem.querySelector('button[onclick^="deleteComment"]').style.display = 'none'; // ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    }

    function updateComment(commentNo, boardNo, button) {
        const listItem = button.closest('li');
        const textarea = listItem.querySelector('textarea');
        const commentContent = textarea.value;

        if (confirm('ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            fetch(`../comment/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `commentNo=${commentNo}&commentContent=${encodeURIComponent(commentContent)}&boardType=1&boardNo=${boardNo}`
            }).then(response => {
                if (response.ok) {
                    alert('ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }
    }

    function cancelEdit(button) {
        const listItem = button.closest('li');
        const textarea = listItem.querySelector('textarea');

        // ì €ì¥í•´ë‘” ì›ë˜ ë‚´ìš©ì„ ë˜ëŒë¦¬ê¸°
        textarea.value = textarea.getAttribute('data-original-content');
        textarea.setAttribute('readonly', true);

        // ë²„íŠ¼ í‘œì‹œ ìƒíƒœ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
        listItem.querySelector('button[onclick="enableEdit(this)"]').style.display = 'inline'; // ìˆ˜ì • ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
        listItem.querySelector('button[onclick^="updateComment"]').style.display = 'none'; // ì €ì¥ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        listItem.querySelector('button[onclick^="cancelEdit"]').style.display = 'none'; // ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        listItem.querySelector('button[onclick^="deleteComment"]').style.display = 'inline'; // ì‚­ì œ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œí•˜ê¸°
    }

    function deleteComment(commentNo, no) {
        if (confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            location.href = '../comment/delete?commentNo=' + commentNo + '&boardNo=' + no +'&boardType=1';
        }
    }
</script>
<script>

    function toggleCommentLike(commentNo) {
<!--    console.log(`Toggling like for commentNo: ${commentNo}`);--> ì½˜ì†” ë¡œê·¸
    fetch(`/comment/toggleCommentLike?commentNo=${commentNo}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
<!--        console.log(`Response data for commentNo ${commentNo}:`, data);--> ì½˜ì†” ë¡œê·¸

        const likeCountElem = document.getElementById(`commentLikeCount-${commentNo}`);
        const likeButtonElem = document.getElementById(`commentLikeButton-${commentNo}`);

        if (likeCountElem && likeButtonElem) {
            likeCountElem.value = data.commentLikeCount;
            likeButtonElem.textContent = data.isCommentLiked ? 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ' : 'ğŸ¤ ì¢‹ì•„ìš”';
            alert(data.message);
        } else {
            console.error(`Elements for commentNo ${commentNo} not found.`, {
                likeCountElem,
                likeButtonElem
            });
        }
    })
    .catch(error => console.error('Error:', error));
}

</script>

<script>
    function changeCommentSort() {
        const sort = document.getElementById('commentSort').value;
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('sort', sort);
        urlParams.set('page', '1');  // í˜ì´ì§€ë¥¼ 1ë¡œ ì´ˆê¸°í™”
        window.location.search = urlParams.toString();
    }
</script>
