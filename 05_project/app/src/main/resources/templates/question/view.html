<!DOCTYPE html>
<html>
<head data-th-replace="~{header :: head}">
</head>
<header data-th-replace="~{header :: #page-header}"></header>
<h1 class="text-center  my-5 mb-4">ì¼ì • ì§ˆë¬¸ ê²Œì‹œíŒ</h1>

<body>
<div class="container my-5" style="max-width: 1200px; margin: 0 auto;">

    <form id="myForm" action="modify" method="post" enctype="multipart/form-data">
        <input type="hidden" name="boardNo" data-th-value='${board.boardNo}'>

        <div class="mb-3">
            <h2 class="form-title" style="margin-left: 10px; font-size: 1.8rem; font-weight: bold;" data-th-text="${board.boardTitle}">ì œëª©</h2>
        </div>

        <div data-th-if="${board}" class="border-bottom pb-3 mb-1">
            <div class="d-flex align-items-center mb-3">
                <img data-th-src="@{https://dgg7dnk35523.edge.naverncp.com/HZiW9aEJy7/user/profile/default.png(type=f,w=20,h=20)}"
                     data-th-unless="${board.writer.userPhoto}"
                     src="/images/default.png"
                     class="rounded-circle me-2" style="width: 40px; height: 40px;">

                <img data-th-if="${board.writer.userPhoto}"
                     data-th-src="@{https://dgg7dnk35523.edge.naverncp.com/HZiW9aEJy7/user/profile/} + ${board.writer.userPhoto} + '?type=f&w=100&h=100'"
                     src="/images/default.png"
                     class="rounded-circle me-2" style="width: 40px; height: 40px;">
                <div>
                    <h5 class="mb-1" data-th-text="${board.writer.userNickname}">ë‹‰ë„¤ì„</h5>
                    <small class="text-muted">
                        ì‘ì„±ì¼: <span data-th-text="${#calendars.format(board.boardCreatedDate, 'yyyy.MM.dd HH:mm')}">ë‚ ì§œ</span>
                        â€¢ ì¡°íšŒ: <span data-th-text="${board.boardCount}">ì¡°íšŒìˆ˜</span>
                    </small>
                </div>
                <div class="ms-auto">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-th-if="${isUserAuthorized}" data-th-onclick="document.getElementById('myForm').submit();">ìˆ˜ì •</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-th-if="${isUserAuthorized}" data-th-onclick="|if(confirm('ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))location.href='@{delete(boardNo=${board.boardNo})}'|">ì‚­ì œ</button>
                </div>
            </div>

            <div class="d-flex align-items-center" >
                <button type="button" id="likeButton" class="btn btn-outline-danger btn-sm me-2"
                        data-th-onclick="|toggleLike(${board.boardNo})|"
                        data-th-text="${isLiked != null and isLiked ? 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ' : 'ğŸ¤ ì¢‹ì•„ìš”'}"></button>
                <span id="likeCount" class="me-3" data-th-text="${board.boardLike}">0</span>

                <button type="button" id="favorButton" class="btn btn-outline-warning btn-sm me-2"
                        data-th-onclick="|toggleFavor(${board.boardNo})|"
                        data-th-text="${isFavored != null and isFavored ? 'â­ ì¦ê²¨ì°¾ê¸° ì·¨ì†Œ' : 'âšª ì¦ê²¨ì°¾ê¸°'}"></button>
                <span id="favorCount" data-th-text="${board.boardFavor}">0</span>
            </div>
        </div>

        <div id="alertMessage" class="alert alert-success d-none" role="alert"
             style="position: fixed; top: 20px; right: 20px; z-index: 1050;">
        </div>

        <div class="modal fade" id="checkLoginModal" tabindex="-1" aria-labelledby="checkLoginModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="margin-top: 300px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="checkLoginModalLabel">ì•Œë¦¼</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ ì°½ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="confirmLoginButton">í™•ì¸</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container my-3">
            <div data-th-each="trip : ${trips}" data-th-object="${trip}">
                <h4 class="mb-2" style="margin-left: 10px; font-size: 1.5rem;">ì „ì²´ ê²½ë¡œ</h4>
                <p class="text-muted mb-3" style="margin-left: 10px; font-size: 0.9rem;" data-th-text="${#dates.format(trip.startDate, 'yyyy.MM.dd(E)')} + ' ~ ' + ${#dates.format(trip.endDate, 'yyyy.MM.dd(E)')}">ì¼ì</p>
<!--            </div>-->

<!--            <div class="d-flex" style="overflow-x: auto; white-space: nowrap;">-->
            <div class="d-flex" style="overflow-x: auto; overflow-y: auto; white-space: nowrap;"> <!-- ê°€ë¡œ ìŠ¤í¬ë¡¤ -->
                <div class="col-md-4 mb-3 d-inline-block" style="width: 300px; margin-right: 20px;" data-th-each="entry : ${groupedSchedules}">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h5 class="text-start"
                            style="font-size: 1.2rem; font-weight: bold;"
                            data-th-text="${entry.key} + 'ì¼ì°¨'">
                            1ì¼ì°¨
                        </h5>
                        <span class="text-muted text-end"
                              style="font-size: 1rem;"
                              data-th-text="${#dates.format(trip.startDate, 'yyyy.MM.dd(E)')}">ë”ë¯¸ ë‚ ì§œ
                        </span>
<!--                        <span class="text-muted text-end"-->
<!--                              style="font-size: 1rem;"-->
<!--                              data-th-text="${#dates.format(#dates.addDays(trip.startDate, entry.key), 'yyyy.MM.dd(E)')}">ë‚ ì§œ-->
<!--                        </span>-->
                    </div>


                    <div class="timeline">
                        <div class="timeline-item mb-1" data-th-each="schedule, iter : ${entry.value}" data-th-object="${schedule}">
                            <div class="p-3 border rounded shadow-sm d-flex justify-content-between align-items-center">

                                <div class="me-2 align-items=start">
                                    <div class="d-flex">
                                        <div class="badge bg-warning text-white" style="font-size: 1rem; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;" data-th-text="${iter.index + 1}">ì¼ì • ìˆœì„œ</div>
                                        <div class="ms-2">
                                            <p class="mb-1 text-secondary" style="font-size: 0.9rem;">16:00 ~ 16:30</p>
                                            <p class="mb-1 text-primary" style="font-size: 0.9rem;">
<!--                                               data-th-if="${board.trip != null and board.trip.thema != null}"-->
<!--                                               data-th-text="${board.trip.thema.themaName}">-->
                                                í…Œë§ˆ ì´ë¦„
                                            </p>
                                            <p class="mb-1" style="font-size: 0.9rem;" data-th-text="*{location.locationName}">ì§€ì—­</p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <img data-th-src="${schedule.location.locationPhoto != null ? schedule.location.locationPhoto : 'https://via.placeholder.com/70x70'}"
                                         alt="Location Photo" class="img-thumbnail" style="width: 70px; height: 70px;">
                                </div>
                            </div>

                            <div class="d-flex align-items-center" data-th-if="${iter.index < entry.value.size() - 1}" style="height: 20px;">
                                <div class="timeline-line mt-2" style="border-left: 2px dotted #ddd; height: 70%; margin-left: 15px;"></div>
                                <div class="text-muted small ms-2" style="font-size: 0.8rem; margin-top: 6px;"><i class="bi bi-car-front"></i> 45ë¶„</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <p>State: <span data-th-text="${board.trip.city.state.stateName}">ì„œìš¸íŠ¹ë³„ì‹œ</span>
            City: <span data-th-text="${board.trip.city.cityName}">ê°•ì„œêµ¬</span></p>

            <div id="map" style="width: 1175px; height: 600px;"></div>

        <div class="mb-2">
            <textarea readonly class="form-control border-0 p-2" style="resize: none; overflow: hidden; font-size: 1rem;" data-th-text="${board.boardContent}" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px';">ë‚´ìš©</textarea>
        </div>

        <div class="mb-2">
            <input readonly type="text" class="form-control border-0 p-2" style="font-size: 1rem;" data-th-value="${board.boardTag}">
        </div>

        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" data-th-onclick="|location.href='@{list}'|">ëª©ë¡</button>
        </div>
    </form>
</div>

<div data-th-replace="~{question/comment}"></div>

<button id="scrollTopButton" onclick="scrollToTop()" class="btn btn-secondary btn-sm" style="position: fixed; bottom: 20px; left: 80%; transform: translateX(-50%); visibility: hidden; padding: 7px 10px;">
    <i class="bi bi-arrow-up"></i> ìƒë‹¨ìœ¼ë¡œ ì´ë™
</button>

<script>
    function toggleLike(boardNo) {
        const isLoggedIn = [[${isLoggedIn}]];
        const likeButton = document.getElementById('likeButton');

        if (!isLoggedIn) {
            const checkLoginModal = new bootstrap.Modal(document.getElementById('checkLoginModal'), {
                backdrop: 'static',
                keyboard: false
            });
            checkLoginModal.show();
        } else {
            fetch(`/question/toggleLike?boardNo=${boardNo}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('likeCount').textContent = data.likeCount;
                document.getElementById('likeButton').textContent = data.isLiked ? 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ' : 'ğŸ¤ ì¢‹ì•„ìš”';
                showAlert(data.message, 'success', likeButton);
            })
            .catch(error => console.error('Error:', error));
        }
    }

    function toggleFavor(boardNo) {
        const isLoggedIn = [[${isLoggedIn}]];
        const favorButton = document.getElementById('favorButton');

        if (!isLoggedIn) {
            const checkLoginModal = new bootstrap.Modal(document.getElementById('checkLoginModal'), {
                backdrop: 'static',
                keyboard: false
            });
            checkLoginModal.show();
        } else {
            fetch(`/question/toggleFavor?boardNo=${boardNo}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('favorCount').textContent = data.favorCount;
                document.getElementById('favorButton').textContent = data.isFavored ? 'â­ ì¦ê²¨ì°¾ê¸° ì·¨ì†Œ' : 'âšª ì¦ê²¨ì°¾ê¸°';
                showAlert(data.message, 'success', favorButton);
            })
            .catch(error => console.error('Error:', error));
        }
    }

        function showAlert(message, type = 'success', targetButton) {
        const alertBox = document.getElementById('alertMessage');
        alertBox.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning', 'alert-info');
        alertBox.classList.add(`alert-${type}`);
        alertBox.textContent = message;

        const buttonRect = targetButton.getBoundingClientRect();
        alertBox.style.position = 'absolute';
        alertBox.style.top = `${buttonRect.top + window.scrollY - alertBox.offsetHeight - 10}px`;
        alertBox.style.left = `${buttonRect.left + window.scrollX}px`;

        alertBox.classList.remove('d-none');
        setTimeout(() => {
            alertBox.classList.add('d-none');
        }, 1000);
    }

</script>

<script>
   function scrollToTop() {
       window.scrollTo({ top: 0, behavior: 'smooth' });
   }

   window.addEventListener('scroll', function() {
       const scrollTopButton = document.getElementById('scrollTopButton');
       if (window.scrollY > 500) {
           scrollTopButton.style.visibility = "visible";
       } else {
           scrollTopButton.style.visibility = "hidden";
       }
   });
</script>

<!--<script>-->
<!--    document.addEventListener('DOMContentLoaded', async () => {-->
<!--    try {-->
<!--        const stateName = /*[[${board.trip.city.state.stateName}]]*/ "defaultState";-->
<!--        const cityName = /*[[${board.trip.city.cityName}]]*/ "defaultCity";-->

<!--        await initializeMap("map", stateName, cityName);-->
<!--    } catch (error) {-->
<!--        console.error("ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:", error);-->
<!--    }-->
<!--});-->
<!--</script>-->

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const stateName = /*[[${board.trip.city.state.stateName} ?: 'ì„œìš¸íŠ¹ë³„ì‹œ']]*/ 'ì„œìš¸íŠ¹ë³„ì‹œ';
            const cityName = /*[[${board.trip.city.cityName} ?: 'ê°•ì„œêµ¬']]*/ 'ê°•ì„œêµ¬';

            await initializeMap('map', stateName, cityName);
        } catch (error) {
            console.error('ì§€ë„ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
        }
    });
</script>

<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0zojwabqn9&submodules=geocoder"></script>
<script data-th-src="@{/js/mapUtils.js}"></script>

</body>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</html>